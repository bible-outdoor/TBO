<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Donation ‚Äì The Bible Outdoor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Support The Bible Outdoor with a donation via PayPal or M-PESA." />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="nav-logo">
      <img src="assets/logo3.png" alt="The Bible Outdoor Logo" />
      <span>The Bible Outdoor</span>
    </div>
    <button class="nav-toggle" aria-label="Open navigation">&#9776;</button>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="sermon.html">Sermon</a></li>
      <li><a href="training.html">Training</a></li>
      <li><a href="archives.html">Archives</a></li>
      <li><a href="notifications.html">Notifications</a></li>
      <li><a href="contacts.html">Contacts</a></li>
      <li><a class="active" href="donation.html">Donation</a></li>
      <li><a href="your-health.html" target="_blank">Your Health</a></li>
      <li>
        <button id="logout-btn" class="nav-logout" style="display: none;" aria-label="Logout">
          <img src="assets/logout.png" alt="Logout" />
        </button>
      </li>
    </ul>
    <span id="welcome-name" style="color: var(--primary); margin-left: 1rem;"></span>
    <button id="modeToggle" class="mode-toggle" aria-label="Toggle dark/light mode"></button>
  </nav>
    <!-- ... (Your existing HTML head and navbar remain unchanged) ... -->
    <main>
      <section class="hero" style="flex-direction:column;text-align:center;">
        <h1>Support Our Mission</h1>
        <p>Your donations help us reach more souls, support the needy, and grow our community. Thank you for your generosity!</p>

        <div class="donation-container">
          <section class="donation-section paypal"></section>
          <section class="donation-section mpesa"></section>
        </div>
      </section>
    </main>

    <!-- M-PESA Modal -->
    <div id="mpesa-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);backdrop-filter:blur(3px);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:var(--white);padding:1.5em;border-radius:1em;
                  max-width:400px;width:90vw;box-shadow:0 4px 20px #0005;
                  text-align:center;position:relative;box-sizing:border-box;
                  margin-left: 5vw; margin-right: 5vw;">
        <button id="close-mpesa-modal" style="position:absolute;top:10px;right:15px;background:none;border:none;font-size:1.5em;color:gray;cursor:pointer;">&times;</button>
        <h3 style="color:var(--primary);margin-bottom:1em;">M-PESA Donation</h3>
        <div id="mpesa-message" style="font-size:1em;color:var(--dark);line-height:1.6;"></div>
      </div>
    </div>

    <!-- FOOTER -->
  <footer>
    <div class="footer-links">
      <a href="index.html">Home</a> |
      <a href="about.html">About</a> |
      <a href="sermon.html">Sermon</a> |
      <a href="training.html">Training</a> |
      <a href="archives.html">Archives</a> |
      <a href="notifications.html">Notifications</a> |
      <a href="contacts.html">Contacts</a> |
      <a href="donation.html">Donation</a>
    </div>
    <div class="footer-contact">
      <div>Sigalagala along Kisumu-Kakamega Highway</div>
      <div>üìû +254719321445 | ‚úâÔ∏è justinebiceptrainer@gmail.com</div>
      <div>
        <a href="https://www.tiktok.com/@nm_jus?_=ZM-8x3slnitC5t&_r=1" aria-label="Tiktok" target="_blank"><img src="assets/tiktok2.png" alt=""></a>
        <a href="https://www.facebook.com/justine.mwakati" aria-label="Facebook" target="_blank"><img src="assets/facebook2.png" alt=""></a>
        <a href="https://www.youtube.com/@justinenm" aria-label="Youtube" target="_blank"><img src="assets/youtube.png" alt=""></a>

      </div>      
      <div>&copy; 2025 The Bible Outdoor. All Rights Reserved.</div>
    </div>
  </footer>
  <script src="js/main.js"></script>
  <script src="scripts/donation.js"></script>
  <script>
  // Fetch and render donation settings from backend API
  async function fetchDonationSettings() {
    try {
      const res = await fetch('https://bible-outdoor-backend.onrender.com/api/settings/donation');
      if (!res.ok) throw new Error('Failed to fetch donation settings');
      return await res.json();
    } catch {
      return {};
    }
  }

  function attachMpesaModalLogic() {
    const mpesaForm = document.getElementById("mpesa-form");
    const mpesaModal = document.getElementById("mpesa-modal");
    const mpesaMessage = document.getElementById("mpesa-message");
    const closeMpesaModal = document.getElementById("close-mpesa-modal");

    if (mpesaForm && mpesaModal && closeMpesaModal && mpesaMessage) {
      mpesaForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const amount = this.querySelector('input[type="number"]').value;
        if (!amount || +amount <= 0) return;

        // Show instructions
        mpesaMessage.innerHTML = `
          ‚úÖ To donate <strong>KES ${amount}</strong>, open your M-PESA menu:<br><br>
          ‚û§ Go to <strong>Lipa na M-PESA</strong><br>
          ‚û§ Choose <strong>Paybill</strong><br>
          ‚û§ Enter Paybill Number: <strong>400200</strong><br>
          ‚û§ Account Number: <strong>01109098319900</strong><br>
          ‚û§ Enter Amount: <strong>KES ${amount}</strong><br><br>
          Thank you for your support! üôè
        `;
        mpesaModal.style.display = "flex";
        this.reset();
      });

      closeMpesaModal.addEventListener("click", () => {
        mpesaModal.style.display = "none";
      });
      mpesaModal.addEventListener("click", (e) => {
        if (e.target === mpesaModal) mpesaModal.style.display = "none";
      });
    }
  }

  async function renderDonationSettings() {
    const settings = await fetchDonationSettings();
    // PayPal
    const paypalEmail = settings.paypal || "not set";
    const paypalLink = paypalEmail && paypalEmail !== "not set"
      ? `https://www.paypal.com/paypalme/${paypalEmail.replace(/@.*$/, '')}`
      : "#";
    // MPESA
    let paybill = "400200", account = "01109098319900";
    if (settings.mpesa) {
      const pbMatch = settings.mpesa.match(/Paybill:\s*([0-9]+)/i);
      const acMatch = settings.mpesa.match(/Account:\s*([0-9]+)/i);
      paybill = pbMatch ? pbMatch[1] : paybill;
      account = acMatch ? acMatch[1] : account;
    }
    // Message
    if (settings.message && document.querySelector('.hero > p')) {
      document.querySelector('.hero > p').textContent = settings.message;
    }
    // Render PayPal
    const paypalSection = document.querySelector('.donation-section.paypal');
    if (paypalSection) {
      paypalSection.innerHTML = `
        <h3>Donate via PayPal</h3>
        <a href="${paypalLink}"
           target="_blank"
           rel="noopener"
           ${paypalEmail === "not set" ? 'onclick="return false;" style="pointer-events:none;opacity:0.5;"' : ''}>
          Donate with PayPal
        </a>
        <div class="donation-note">PayPal Email: ${paypalEmail}</div>
      `;
    }
    // Render MPESA
    const mpesaSection = document.querySelector('.donation-section.mpesa');
    if (mpesaSection) {
      mpesaSection.innerHTML = `
        <h3>Donate via M-PESA</h3>
        <form id="mpesa-form">
          <input type="number" min="1" required placeholder="Amount (KES)" />
          <button type="submit">Send</button>
        </form>
        <div class="mpesa-instructions">
          M-PESA Paybill: <strong>${paybill}</strong> &nbsp;|&nbsp; Account: <strong>${account}</strong>
        </div>
      `;
    }
    // After rendering, re-attach modal logic:
    attachMpesaModalLogic();
  }

  // Initial render
  renderDonationSettings();

  // Live update on custom event
  window.addEventListener('donationSettingsUpdated', renderDonationSettings);
</script>

</body>
</html>